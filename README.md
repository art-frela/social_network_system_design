# SYSTEM DESIGN социальной сети для курса по системному дизайну [balun.courses.system-design](https://balun.courses/courses/system_design)

> Социальная сеть для путешественников - **Wayfarer**

- [SYSTEM DESIGN социальной сети для курса по системному дизайну balun.courses.system-design](#system-design-социальной-сети-для-курса-по-системному-дизайну-baluncoursessystem-design)
  - [Функциональные требования](#функциональные-требования)
  - [Нефункциональные требования](#нефункциональные-требования)
  - [Расчет нагрузки](#расчет-нагрузки)
  - [Модель данных и расчет дисков](#модель-данных-и-расчет-дисков)
    - [Сущности](#сущности)
    - [Расчет дисков](#расчет-дисков)


![logo](assets/img/logo_orig.jpg)


## Функциональные требования

 1. Публикация постов в виде текста и фотографий
    1. полный CRUD
 2. Просмотр своих постов и др путешественников
 3. Оценка на посты
    1. Можно менять/удалять
 4. Добавлять комментарии к постам
    1. Можно удалять и редактировать
 5. Привязка фотографий к географическим местам
    1. по координатам из метаданных фотографий
    2. в ручном режиме пользователем
 6. Подписка на посты др путешественников
    1. Отписка
 7. Поиск популярных мест для путешествий
    1. Просмотр постов к этим местам
 8. Показ постов 
 9. Глубина просмотра ленты бесконечно
10. …


## Нефункциональные требования

1. Количество пользователей (DAU) = 10_000_000 активных пользователей в день
2. Поведение пользователей - в среднем один пользователь 
   1. просматривает ленту 1 раз в день
   2. пишет новый пост 1 раз в 10 дней
   3. пишет комментарий 2 раза в день
   4. ставит оценку посту 5 раз в день
   5. …
3. География аудитории соцсети -  страны СНГ
4. Сезонность - да, летние каникулы нагрузка выше в 2 раза, новогодние праздники - нагрузка выше в 1,5 раза
5. Время хранения постов и фотографий условно бесконечно
6. Лимиты и ограничения
    1. Максимальное число подписчиков не ограничено
       1. проблему с мега популярными путешественниками (celebrity) будем решать
    2. Максимальный размер текста одного поста - 5000 символов
    3. Средний размер одного поста - 680 символов (в среднем 2000Байт)
    4. Максимальное кол-во фотогафий в одном посте - 10
    5. Максимальный размер одной фотографии - 512Kб
    6. В среднем один пост содержит 5 фотографий
    7. В среднем размер оригинала одной фотографии - 200Kб
    8. Комментарии в основном без фотографий
    9. Максимальный размер одного комментария - 800 символов
   10. Размер фотографии в ленте в среднем 200Кб
   11. Один пользователь в среднем просматривает 5 оригиналов фотографии из ленты
   12. …
7. Временные ограничения
   1. Пользователь публикует среднего размера пост менее чем за 1 секунду
   2. Пользователь получает последние 10 постов ленты менее чем за 1 секунду
   3. Пользователь получает последующие 10 постов ленты менее чем за 3 секунды
   4. Пользователь публикует комментарий к посту менее чем за 1 секунду
   5. Пользователь ставит оценку посту менее чем за 1с
   6. …
8. Доступность приложения - Не более, чем несколько часов простоя в год.
   1. Уровень доступности - 3 девятки вполне достаточно


## Расчет нагрузки

```javascript
RPS = dau * avg_requests_per_day_by_user / 86 400 
Traffic = rps * avg_request_size
Connections = dau * 0.1

dau = 10000000
```

| Операция                               | RPS                        | Traffic            | Connections                | Comment                                                                                                                                                                                                                        |
| -------------------------------------- | -------------------------- | ------------------ | -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Создание новых постов                  | 10_000_000*0.1/86400 \~ 12 | 12 * 2,5Mb = 30Mb  | 10_000_000*0.1 = 1_000_000 | Раз в 10 дней это оптимистично - обычно гораздо реже - раз в неделю если за каждые выходные отчитываться, но про дачу 5 раз писать не будешь же. но есть более активные пользователи, которые будут и поход в магазин освещать |
| Редактирование постов                  | 0                          |                    |                            | Если фотки новые добавлять, но это оч редко                                                                                                                                                                                    |
| Удаление постов                        | 0                          |                    |                            | редко                                                                                                                                                                                                                          |
| Просмотр ленты                         | 10_000_000*1/86400 \~ 120  | 120*0.5Mb = 60Mb   |                            |                                                                                                                                                                                                                                |
| Просмотр оригиналов фотографий в посте | 10_000_000*5/86400 \~ 600  | 600*2.5Mb \~ 1.5Gb |                            | Преимущественно чтение                                                                                                                                                                                                         |
| Создание комментариев                  | 10_000_000*2/86400 \~ 240  | 240*50B \~ 12KB    |                            |                                                                                                                                                                                                                                |
| Редактирование комментариев            | 0                          |                    |                            |                                                                                                                                                                                                                                |
| Удаление комментариев                  | 0                          |                    |                            |                                                                                                                                                                                                                                |
| Подписка                               | 10_000_000*0.1/86400 \~ 12 | 12*16B = 192B      |                            |                                                                                                                                                                                                                                |
| Отписка                                | 10_000_000*0.03/86400 \~ 4 | 4*16B = 64B        |                            |                                                                                                                                                                                                                                |
## Модель данных и расчет дисков

### Сущности

| Сущность\таблица   | Таблица        | Тип БД            | Описание схемы                                     | Размер 1 записи + Индексы + выравнивание (только PK) \~[Byte] | Число записей в год | Прирост в год | Операций в секунду (I/O) | Интенсивность трафика |
| ------------------ | -------------- | ----------------- | -------------------------------------------------- | ------------------------------------------------------------- | ------------------- | ------------- | ------------------------ | --------------------- |
| Пользователи       | users          | RDBMS             | [database/main_rdms.dbml](database/main_rdms.dbml) | 137+40                                                        | 10000000            | 1,77GB        | 12                       | 2124Bps               |
| Подписки           | subscriptions  | RDBMS             | [database/main_rdms.dbml](database/main_rdms.dbml) | 40+40                                                         | 252288000           | 20,18GB       | 16                       | 1280Bps               |
| Локации            | locations      | RDBMS             | [database/main_rdms.dbml](database/main_rdms.dbml) | 81+40                                                         | 2000000             | 0,25GB        | 2                        | 242Bps                |
| Посты              | posts          | RDBMS             | [database/main_rdms.dbml](database/main_rdms.dbml) | 2824+40                                                       | 378432000           | 1084GB        | 12                       | 34368Bps              |
| Комментарии        | posts_comments | RDBMS             | [database/main_rdms.dbml](database/main_rdms.dbml) | 616+40                                                        | 7568640000          | 4965GB        | 240                      | 157440Bps             |
| Оценки             | posts_scores   | RDBMS             | [database/main_rdms.dbml](database/main_rdms.dbml) | 42+40                                                         | 1135296000          | 93,1Gb        | 36                       | 2952Bps               |
| Фотографии         |                | Object storage    | [database/main_blob.dbml](database/main_blob.dbml) | *512016*                                                      | 1892160000          | 969816GB      | 180                      | 92MBps                |
| Группировка оценок |                | Key-Value Storage | [database/main_kv.dbml](database/main_kv.dbml)     | 32                                                            | 378432000           | 12,1GB        | 120                      | 3840Bps               |

| БД                | Объем данных/год (Capacity) | Операций в секунду | Интенсивность трафика (**traffic_per_second**) |
| ----------------- | --------------------------- | ------------------ | ---------------------------------------------- |
| RDBMS             | 6164,3GB→6,2TB              | 318                | 198406Bps                                      |
| Object storage    | 969816GB→970TB              | 180                | 92MBps                                         |
| Key-Value Storage | 12,1GB                      | 120                | 3840Bps→0,004MBps                              |


### Расчет дисков

```javascript
Disks_for_capacity = capacity / disk_capacity
Disks_for_throughput = traffic_per_second / disk_throughput
Disks_for_iops = iops / disk_iops
Disks = max(ceil(Disks_for_capacity), ceil(Disks_for_throughput), ceil(Disks_for_iops))
```

Где:
**disk_capacity** - объем одного диска  
**capacity** - суммарный объем данных, которое необходимо хранить  
**traffic_per_second** - суммарный трафик на запись/чтение в секунду  
**disk_throughput** - пропускная способность одного диска  
**iops** - суммарное количество запросов в секунду  
**disk_iops** - количество операций ввода-вывод диска в секунду  
**ceil** - функция округления вверх до целого числа

| хар-ка\БД            | RDBMS                   | Object storage      | Key-Value Storage        |
| -------------------- | ----------------------- | ------------------- | ------------------------ |
| disks_for_capacity   | 6,2TB/2TB=3,1           | 970TB/20TB=48,5     | 12,1GB/128GB=0,94        |
| disks_for_throughput | 0,2MBps/100MBps = 0,002 | 92MBps/100MBps=0,92 | 0,004MBps/100MBps = 4e-5 |
| disks_for_iops       | 318/100=3,18            | 180/100=1,8         | 120/100=1,2              |
| DISKS                | 4                       | 49                  | 2                        |
